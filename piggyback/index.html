<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>MVP</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
	<style>
		body {
			margin: 0px;
			border: 0px;
			padding: 0px;
		}

		#map {
			height: 800px;
			width: 90%;
		}
	</style>
</head>

<body>
	<h1>Demo</h1>
	<input type="checkbox" id="show_roads" checked/>
	<label for="show_roads">Show A/B Street roads</label>
	<span id="traffic_controls"></span>
	<div id="map"></div>
	<script type="module">
		import init, { PiggybackDemo } from "./pkg/piggyback.js";

		async function setup() {
			// Initialize the WASM function.
			await init();

			var loadPath = new URL(window.location).searchParams.get('map');
			if (loadPath == null) {
				loadPath = '/data/system/us/seattle/maps/montlake.bin';
			}

			// TODO Ideally we'd display the map immediately, but not sure how to make onAdd async
			console.log(`fetching ${loadPath}`);
			const resp = await fetch(loadPath);
			const mapBytes = await resp.arrayBuffer();

			// TODO I feel like I probably just copied this from an example somewhere
			mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

			// Create the Mapbox map
			const map = new mapboxgl.Map({
				container: 'map',
				style: 'mapbox://styles/mapbox/satellite-streets-v11',
				center: [-122.3037, 47.6427],
				zoom: 16,
				antialias: true,
				// TODO This appears to duplicate the parameter as soon as we move...
				//hash: `map=${loadPath}`
				hash: true
			});

			var piggyback = null;

			const widgetryLayer = {
				id: 'widgetry',
				type: 'custom',
				onAdd: function (map, gl) {
					piggyback = PiggybackDemo.create_with_map_bytes(gl, mapBytes);
					// TODO If the URL didn't specify an initial location, warp to the center of this map?
					sync_canvas();
				},
				render: function (gl, matrix) {
					if (piggyback == null) {
						return;
					}
					if (map.getZoom() >= 16) {
						piggyback.draw_zoomed(document.getElementById("show_roads").checked);
					} else {
						piggyback.draw_unzoomed();
					}
				}
			};

			map.on('load', () => {
				map.addLayer(widgetryLayer);
			});
			map.on('move', sync_canvas);
			map.on('click', (e) => {
				const debug = piggyback.debug_object_at(e.lngLat.lng, e.lngLat.lat);
				if (debug != null) {
					new mapboxgl.Popup()
						.setLngLat(e.lngLat)
						.setHTML(`<pre style="overflow-x: scroll; overflow-y: scroll; max-width: 240px; max-height: 300px;">${debug}</pre>`)
						.addTo(map);
				}
			});
			// We don't have map until here, so set up the handler now
			document.getElementById('show_roads').onclick = function() {
				map.triggerRepaint();
			}

			function sync_canvas() {
				// If things broken during initialization, don't spam the console trying to call methods on a null object
				if (piggyback != null) {
					const bounds = map.getBounds();
					const ne = bounds.getNorthEast();
					const sw = bounds.getSouthWest();
					piggyback.move_canvas(ne.lng, ne.lat, sw.lng, sw.lat);
				}
			}

			function traffic_controls_inactive() {
				const span = document.getElementById("traffic_controls");
				span.innerHTML = `
				<button type="button" onclick="start_traffic_sim()">Start traffic simulation</button>
				`;
			}

			function traffic_controls_active() {
				const span = document.getElementById("traffic_controls");
				span.innerHTML = `
				<button type="button" onclick="pause_or_resume()">Pause / resume</button>
				<button type="button" onclick="clear_traffic_sim()">Clear simulation</button>
				`;
			}

			var lastTime = performance.now();
			var animationRequest = null;

			function start_traffic_sim() {
				traffic_controls_active();
				lastTime = performance.now();
				animationRequest = requestAnimationFrame(runSimulation);
				piggyback.spawn_traffic();
			}

			function pause_or_resume() {
				if (animationRequest == null) {
					lastTime = performance.now();
					animationRequest = requestAnimationFrame(runSimulation);
				} else {
					cancelAnimationFrame(animationRequest);
					animationRequest = null;
				}
			}

			function clear_traffic_sim() {
				traffic_controls_inactive();
				cancelAnimationFrame(animationRequest);
				animationRequest = null;
				piggyback.clear_traffic();
			}

			function runSimulation(timestamp) {
				const now = performance.now();
				const dt = now - lastTime;
				// This is called over 60 times per second or so! Throttle to about 10fps
				if (dt >= 100) {
					lastTime = now;
					piggyback.advance_sim_time(dt);
					map.triggerRepaint();
				}
				animationRequest = requestAnimationFrame(runSimulation);
			}

			traffic_controls_inactive();

			// So the onclick handlers work. Alternatively, grab them here and set onclick
			window.start_traffic_sim = start_traffic_sim;
			window.pause_or_resume = pause_or_resume;
			window.clear_traffic_sim = clear_traffic_sim;
		}

		setup();
	</script>
</body>

</html>
