<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>MVP</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
	<style>
		body {
			margin: 0px;
			border: 0px;
			padding: 0px;
		}

		#map {
			height: 500px;
			width: 90%;
		}
	</style>
</head>

<body>
	<h1>Demo</h1>
	<div id="map"></div>
	<script type="module">
		import init, { PiggybackDemo } from "./pkg/mapbox.js";

		async function setup() {
			// Initialize the WASM function.
			await init();

			// TODO Ideally we'd display the map immediately, but not sure how to make onAdd async
			console.log('fetching map file');
			const resp = await fetch('http://0.0.0.0:8000/data/system/us/seattle/maps/montlake.bin');
			const mapBytes = await resp.arrayBuffer();

			// TODO I feel like I probably just copied this from an example somewhere
			mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

			// Create the Mapbox map
			const map = new mapboxgl.Map({
				container: 'map',
				style: 'mapbox://styles/mapbox/streets-v11',
				center: [-122.3037, 47.6427],
				zoom: 13
			});

			var piggyback = null;

			const widgetryLayer = {
				id: 'widgetry',
				type: 'custom',
				onAdd: function (map, gl) {
					piggyback = PiggybackDemo.create_with_map_bytes(gl, mapBytes);
					sync_canvas();
				},
				render: function (gl, matrix) {
					piggyback.draw();
				}
			};

			map.on('load', () => {
				map.addLayer(widgetryLayer);
			});
			map.on('move', sync_canvas);

			function sync_canvas() {
				const bounds = map.getBounds();
				const ne = bounds.getNorthEast();
				const sw = bounds.getSouthWest();
				piggyback.move_canvas(ne.lng, ne.lat, sw.lng, sw.lat);
			}
		}

		setup();
	</script>
</body>

</html>
