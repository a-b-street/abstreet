<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>MVP</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
	<!-- TODO Why is the ecosystem so enormous and unclear? Webpack? Browserify? -->
	<link href="node_modules/mapbox-gl/dist/mapbox-gl.css" rel="stylesheet">
	<script src="node_modules/mapbox-gl/dist/mapbox-gl.js"></script>
	<style>
		body {
			margin: 0px;
			border: 0px;
			padding: 0px;
		}

		#map {
			height: 800px;
			width: 90%;
		}
	</style>
</head>

<body>
	<h1>Demo</h1>
	<div id="map"></div>
	<script type="module">
		import init, { PiggybackDemo } from "./pkg/mapbox.js";

		async function setup() {
			// Initialize the WASM function.
			await init();

			// TODO Ideally we'd display the map immediately, but not sure how to make onAdd async
			console.log('fetching map file');
			const resp = await fetch('/data/system/us/seattle/maps/montlake.bin');
			const mapBytes = await resp.arrayBuffer();

			// TODO I feel like I probably just copied this from an example somewhere
			mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

			// Create the Mapbox map
			const map = new mapboxgl.Map({
				container: 'map',
				style: 'mapbox://styles/mapbox/streets-v11',
				center: [-122.3037, 47.6427],
				zoom: 16,
				antialias: true,
				hash: true
			});

			var piggyback = null;

			const widgetryLayer = {
				id: 'widgetry',
				type: 'custom',
				onAdd: function (map, gl) {
					piggyback = PiggybackDemo.create_with_map_bytes(gl, mapBytes);
					sync_canvas();
				},
				render: function (gl, matrix) {
					if (map.getZoom() >= 16) {
						piggyback.draw_zoomed();
					}
				}
			};

			map.on('load', () => {
				map.addLayer(widgetryLayer);
			});
			map.on('move', sync_canvas);
			map.on('click', (e) => {
				const debug = piggyback.debug_object_at(e.lngLat.lng, e.lngLat.lat);
				if (debug != null) {
					new mapboxgl.Popup()
						.setLngLat(e.lngLat)
						.setHTML(`<pre style="overflow-x: scroll; overflow-y: scroll; max-width: 240px; max-height: 300px;">${debug}</pre>`)
						.addTo(map);
				}
			});

			function sync_canvas() {
				const bounds = map.getBounds();
				const ne = bounds.getNorthEast();
				const sw = bounds.getSouthWest();
				piggyback.move_canvas(ne.lng, ne.lat, sw.lng, sw.lat);
			}
		}

		setup();
	</script>
</body>

</html>
